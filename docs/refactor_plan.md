# パーサー高速化リファクタリング計画

`oni-comb-parser-rs` は Scala 由来のパーサーコンビネータ API を提供していますが、内部実装が `Rc<dyn Fn>` に依存しているため、`nom` や `pom` と比較して大幅に遅いという課題があります。本計画では「Scala ライクな記述性を保ちつつ、性能面のボトルネックを解消する」ための段階的なリファクタリング方針を整理します。

## 課題の整理
- **動的ディスパッチによるオーバーヘッド**: `Parser` が `Rc<dyn Fn>` を保持しており、コンビネータごとに仮想関数呼び出しが発生。
- **`ParseState`/`ParseResult` のコピー**: 値オブジェクトを多用し、成功経路でもヒープ割り当てやデータコピーが頻発。
- **`Vec<char>` 変換コスト**: 文字列入力を UTF-8 のまま扱わず、毎回 `Vec<char>` へデコードしている。
- **キャッシュ／エラーハンドリング**: 失敗情報やキャッシュ結果を `clone` して保持しており、軽量化の余地が大きい。

## リファクタリング方針
1. **実行器レイヤーをジェネリクス化**
   - `Parser` の内部表現を `Rc<dyn Fn>` ではなく、静的ディスパッチ可能な構造 (`enum ParserImpl<F>` など) に置き換える。
   - 互換性のために、公開 API では従来の `Parser` 型を維持し、内部で `impl ParserRunner` を生成する 2 層構造を取る。

2. **中間表現→最適化→実行器のパイプライン化**
   - Scala の `packrat` 方式を参考に、DSL で構築したパーサー木を一旦 IR (中間表現) に落とし込み、ビルドステップで最適化＆静的ディスパッチへ変換する。
   - 将来的には `#[proc_macro]` やコード生成でゼロコスト版を自動生成することも視野に入れる。

3. **`ParseState` / `ParseResult` の借用ベース化**
   - 成功時は新しいバッファを生成せず、`(&'a [I], A)` のようなタプルで次の位置と結果を返すように変更。
   - 失敗時の `ParseError` は参照とインデックスの組みにとどめ、`clone` を極力避ける。

4. **文字列処理の再設計**
   - 既定の実装を `&[u8]` ベースにし、`char` が必要な場面ではイテレータや `chars()` を局所的に利用する。
   - これに伴い `oni_comb_parse_json_bytes` を標準化し、`Vec<char>` 変換は非推奨化する。

5. **キャッシュとデバッグ機能の軽量化**
   - `cache` や `logging` のために `Rc` や `HashMap` を使う機能はオプション扱いにし、機能を有効化したときのみオーバーヘッドが発生するように設計。
   - `ParseError` の詳細メッセージ構築も、必要時に遅延生成する。

## 実装ステップ案
- **Phase 1**: コア `Parser` の内部を `enum ParserImpl` + `Arc` などに置き換え、よく使うコンビネータから順に静的ディスパッチへ移行。
- **Phase 2**: `ParseState` / `ParseResult` の借用ベース化。入力スライスと結果値の扱いを見直し、ヒープ割り当てを削減。
- **Phase 3**: 文字列処理を UTF-8 ベースに統一し、`char` 変換を局所化。
- **Phase 4**: 中間表現 + 実行器の分離。DSL から最適化済みパイプラインを生成する仕組みを導入。
- **Phase 5**: キャッシュ・ロギングなどの補助機能を拡張し、パフォーマンスフラグで制御可能にする。

## TODO
- [x] `Parser` の内部表現を見直し、`Rc<dyn Fn>` を廃して静的ディスパッチ可能な構造に置き換える。
- [ ] `ParseState` / `ParseResult` を借用中心に再設計し、成功経路のコピーやヒープ割り当てを削減する。
- [ ] 標準の JSON パーサーを `&[u8]` ベースに統一し、`Vec<char>` への変換を排除する。
- [ ] DSL → IR → 最適化済み実行器のビルドパイプライン (またはマクロ) を設計する。
- [ ] キャッシュ・ロギング・エラー組み立てを軽量化し、オプションで有効化できるようにする。

## 参考ベンチ結果 (2025-09-26)
- `json_small`: `oni-comb-rs (char)` は 4.1〜4.5 µs、`oni-comb-rs (byte)` は 3.9 µs 前後、`pom` は 2.1〜2.9 µs、`nom` は 0.03 µs 程度。
- `json_large`: `oni-comb-rs (char)` は 30〜350 ms、`oni-comb-rs (byte)` は 29〜350 ms、`pom` は 13〜212 ms、`nom` は 0.5〜7 ms。
- 動的ディスパッチとコピーが遅さの主因であり、上記リファクタリングを順次行うことで `pom` から `nom` に近い性能を狙う。
