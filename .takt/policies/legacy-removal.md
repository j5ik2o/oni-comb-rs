# レガシーコード削除ポリシー

## 原則

| 原則 | 基準 |
|------|------|
| 呼び出し元ゼロの確認 | grep/参照検索で利用箇所がないことを証明 → 未確認なら REJECT |
| ビルド通過 | 削除後に `cargo build --workspace` が通ること → 失敗なら REJECT |
| テスト通過 | 削除後に `cargo test --workspace` が通ること → 失敗なら REJECT |
| 公開API非破壊 | `pub` な型・関数の削除は crates.io 公開クレートで破壊的変更 → SemVer考慮なしなら REJECT |
| 段階的削除 | 一度の変更で削除するファイル数は10以下を推奨 → 超過は分割を検討 |

## 削除対象の分類と判定

| 対象 | 判定 | アクション |
|------|------|-----------|
| `#[allow(dead_code)]` 付きの未使用コード | 即削除可 | 削除 + dead_code属性も除去 |
| `#[deprecated]` 付きAPI（呼び出し元ゼロ） | 即削除可 | 削除 + 関連テスト除去 |
| `#[deprecated]` 付きAPI（呼び出し元あり） | 移行必要 | 呼び出し元を新APIに移行後に削除 |
| `// TODO: remove` 等のコメント付きコード | 要確認 | コメントの指すコードが不要なら削除 |
| `Legacy*`, `Old*`, `*V1` 命名のアダプタ | 要確認 | 利用状況を確認してから判断 |
| バージョン分岐 (`if version < X`) | 要確認 | 旧バージョンサポート終了後に削除 |

## 公開シンボルの保護

| 対象 | 判定 | 理由 |
|------|------|------|
| `pub trait` に定義されたメソッド | **削除禁止** | 公開インターフェイスであり、クレート利用者が実装・呼び出しする可能性がある |
| `pub trait` のデフォルト実装 | **削除禁止** | 同上。内部で未使用でも外部契約の一部 |
| `pub fn`, `pub const`, `pub type` 等 | **削除禁止** | 公開APIであり、外部クレートから参照される可能性がある |
| 上記の `dead_code` 警告 | **警告抑制で対応** | 削除ではなく `#[allow(dead_code)]` で対処する |

`pub` なシンボル（trait・関数・型・定数など）は、クレート内部で呼び出し元がゼロであっても削除対象としない。
これらはクレートの公開インターフェイスであり、利用者が使用する前提で公開されている。
`dead_code` 警告が出ている場合は、削除ではなく警告抑制で対応すること。

## 禁止事項

- 呼び出し元を確認せずに「使われていないはず」で削除する
- 公開クレートの `pub` シンボルを SemVer 考慮なしに削除する
- **`pub` なシンボル（trait・関数・型・定数など）を「内部未使用」として削除する**
- テストを削除して「テスト通過」とする（テスト対象コードの削除に伴うテスト削除は許可）
- 削除と新機能追加を同一コミットに混ぜる
